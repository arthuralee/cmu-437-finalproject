{% extends "base.html" %}

{% block title %}Trade{% endblock %}

{% block errors %}
  {% for error in errors %}
    <p class="alert alert-danger">
    {{error}}
    </p>
  {% endfor %}
{% endblock %}

{% block content %}

{% if received < 0 %}
<!-- trade just made -->
You have successfully created your trade! Here it is:
{% endif %}

<h1>Trade #{{trade.id}}</h1>

<div class="row">
  <div class="col-md-8">
    <div id="chat">
      <ul id="messages">
      </ul>
      <form method="post" action="/trade/{{id}}/message" id="chatform">
        <input type="text" class="form-control" name="q" id="chattext" placeholder="Type a message then press enter" />
        {% csrf_token %}
      </form>
    </div>
  </div>
  <div class="col-md-4">
    STATUS:   {{trade.status}}
    {% if trade.status == -2 %} CANCELLED
    {% elif trade.status == -1 %} COMPLETED
    {% elif trade.status == 0 %} AWAITING ACCEPTANCE FROM {{trade.user2.username}}
    {% elif trade.status == 1 %} ACCEPTED BY BOTH PARTIES. ITEMS IN PROGRESS
    {% elif trade.status == 2 %} ACCEPTED, WAITING FOR {{trade.user2.username}}'s ITEMS
    {% elif trade.status == 3 %} ACCEPTED, WAITING FOR {{trade.user1.username}}'s ITEMS
    {% else %} ERROR
    {% endif %}

    {% if trade.status == 0 and not cur1 %}
      <a href="/trade/{{trade.id}}/accept" class="btn btn-primary">Accept trade</a> 
      <a class="btn btn-warning" href="/trade/new?with={{trade.user1.username}}&from={{trade.id}}">
        Reoffer</a> 
    {% endif %}

    {% if trade.status == 0 %}
      <a href="/trade/{{trade.id}}/cancel" class="btn btn-danger">Cancel trade</a> 
    {% endif %}

    {% if trade.status > 0 %}
      {% if not received %}
        Have you received your items yet? Click if you have
        <a class="btn btn-primary" href="/trade/{{trade.id}}/received">HERE</a> 
      {% endif %} <br>

      {% if trade.status == 2 %}
        {% if not cur1 %} 
          <!-- other person received -->
          {{trade.user2.username}} has received your items
        {% else %} 
          {{trade.user2.username}} has not received your items
        {% endif %}
      {% elif trade.status == 3 %}
        {% if cur1 %} 
          <!-- other person received -->
          {{trade.user2.username}} has received your items
        {% else %} 
          {{trade.user2.username}} has not received your items
        {% endif %}
      {% elif trade.status == 1 %}
        {% if cur1 %} 
          <!-- no one received -->
          {{trade.user2.username}} has not received your items
        {% else %} 
          {{trade.user1.username}} has not received your items
        {% endif %}
      {% else %}
      {% endif %} 
    {% endif %}
  </div>
</div>
<hr>
<div class="row">
  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3><img src="/image/user/{{trade.user1.username}}" width="40" height="40" /> <a href="/user/{{trade.user1.username}}">{{trade.user1.username}}</a></h3>
      </div>
      <ul class="item-list panel-body">
        <!-- these items are selected -->
        {% for item in user1selectitems %}
          {% include "trade/item_list_single.html" %}
        {% endfor %}
      </ul>
    </div>
  </div>

  <div class="col-md-6">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3><img src="/image/user/{{trade.user2.username}}" width="40" height="40" /> <a href="/user/{{trade.user2.username}}">{{trade.user2.username}}</a></h3>
      </div>
      <ul class="item-list panel-body">
        {% for item in user2selectitems %}
          {% include "trade/item_list_single.html" %}
        {% endfor %}
      </ul>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
csrftoken = getCookie('csrftoken');
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
      xhr.setRequestHeader("X-CSRFToken", csrftoken);
    }
});

function refreshMsg() {
  $.get('/trade/{{trade.id}}/message', function(data) {
    $('#messages').html('');

    for (var i=0; i<data.length; i++) {
      $('#messages').append($('<li>').html('<span>' + data[i].username + ': </span>' + data[i].body))
    }
    $('#messages').scrollTop($('#messages')[0].scrollHeight);
  });
}

refreshMsg();
window.setInterval(refreshMsg, 5000);

$('#chatform').submit(function(e) {
  e.preventDefault();
  $.post('/trade/{{trade.id}}/message', {body: $('#chattext').val()}, function() {
    $('#chattext').val('');
    refreshMsg();
  });
  
});
</script>
{% endblock %}